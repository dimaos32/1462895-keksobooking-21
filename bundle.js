(()=>{"use strict";(()=>{const e={room:["комната","комнаты","комнат"],guest:["гостя","гостей","гостей"]},t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=(e=0,t=100)=>e+Math.floor(Math.random()*(t-e+1));window.util={Key:{ENTER:"Enter",ESCAPE:"Escape"},getRandomIntNumber:o,getRandomArrayElements:(e,t=1)=>{let n=e.slice(),r=[];for(let e=0;e<n.length&&e<t;e++){const t=o(e,n.length-1);r.push(n[t]);const a=n[t];n[t]=n[e],n[e]=a}return r},getQEndings:(t=1,o)=>{if(t%100<11||t%100>14){if(t%10==1)return`${t} ${e[o][0]}`;if(t%10>1&&t%10<5)return`${t} ${e[o][1]}`}return`${t} ${e[o][2]}`},getHousingType:e=>t[e],addId:e=>e.map(((e,t)=>Object.assign({},e,{id:""+t}))),checkExtensionAccordance:(e,t)=>t.some((t=>e.name.toLowerCase().endsWith(t))),debounce:(e,t=500)=>{let o=null;return function(...n){o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...n)}),t)}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o,n,r)=>{const a=new XMLHttpRequest;a.responseType="json",a.timeout=1e4,a.open(e,t),"POST"===e?a.send(r):a.send(),a.addEventListener("load",(()=>{200===a.status?o(a.response):n(`Статус ответа: ${a.status} ${a.statusText}`)})),a.addEventListener("error",(function(){n("Произошла ошибка соединения")})),a.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${a.timeout/1e3} с`)}))};window.backend={load:(o,n)=>{t("GET",e+"/data",o,n)},send:(o,n,r)=>{t("POST",e,n,r,o)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t="img/muffin-grey.svg",o={palace:1e4,flat:1e3,house:5e3,bungalow:0},n={1:'<option value="1" selected>для 1 гостя</option>',2:'<option value="2">для 2 гостей</option>\n      <option value="1" selected>для 1 гостя</option>',3:'<option value="3">для 3 гостей</option>\n      <option value="2">для 2 гостей</option>\n      <option value="1" selected>для 1 гостя</option>',100:'<option value="0" selected>не для гостей</option>'},r=document.querySelector(".map__filters"),a=document.querySelector(".ad-form"),i=document.querySelector(".ad-form__reset"),d=a.querySelector(".ad-form-header__input"),s=a.querySelector(".ad-form-header__preview img"),c=a.querySelector("#title"),l=a.querySelector("#address"),u=a.querySelector("#price"),p=a.querySelector("#type"),m=a.querySelector(".ad-form__element--time"),f=a.querySelector("#timein"),w=a.querySelector("#timeout"),y=a.querySelector("#room_number"),v=a.querySelector("#capacity"),_=a.querySelector("#images"),g=a.querySelector(".ad-form__photo"),E=(e,t)=>{const o=e.querySelectorAll("fieldset"),n=e.querySelectorAll("select");o.forEach((e=>{e.disabled=!t})),n.forEach((e=>{e.disabled=!t}))},S=()=>{const e=window.pin.getMainMapPinCoords();l.value=`${e.x}, ${e.y}`},q=()=>{v.innerHTML=n[y.value]},h=()=>{const e=o[p.value];u.placeholder=e,u.min=e},L=()=>{const e=document.querySelector("main"),o=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.append(o),o.addEventListener("click",(()=>{o.remove()})),document.addEventListener("keydown",(e=>{e.key===window.util.Key.ESCAPE&&o.remove()})),s.src=t,g.innerHTML="",a.reset(),window.main.deactivatePage()},x=()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.append(t),t.addEventListener("click",(()=>{t.remove()})),document.addEventListener("keydown",(e=>{e.key===window.util.Key.ESCAPE&&t.remove()}))};d.addEventListener("change",(t=>{(t=>{const o=t.target.files[0];if(window.util.checkExtensionAccordance(o,e)){const e=new FileReader;e.addEventListener("load",(()=>{s.src=e.result})),e.readAsDataURL(o)}})(t)})),c.addEventListener("input",(()=>{const e=c.value.length;e<30?c.setCustomValidity(`Еще ${30-e} символов`):e>100?c.setCustomValidity(`Удалите лишние ${e-100} символов`):c.setCustomValidity(""),c.reportValidity()})),u.addEventListener("input",(()=>{const e=u.value,t=o[p.value];e<t?u.setCustomValidity(`Минимальная цена за ночь ${t} руб. Вам стоит увеличить цену.`):e>1e6?u.setCustomValidity("Максимальная цена за ночь 1000000 руб. Вам стоит уменьшить цену."):u.setCustomValidity(""),u.reportValidity()})),p.addEventListener("change",(()=>{h()})),m.addEventListener("change",(e=>{w.value=e.target.value,f.value=e.target.value})),y.addEventListener("change",(()=>{q()})),_.addEventListener("change",(t=>{(t=>{const o=t.target.files[0];if(window.util.checkExtensionAccordance(o,e)){const e=new FileReader;e.addEventListener("load",(()=>{const t=document.createElement("img");g.innerHTML="",t.src=e.result,t.classList.add("ad-form__photo-preview"),g.append(t)})),e.readAsDataURL(o)}})(t)})),a.addEventListener("submit",(e=>{e.preventDefault(),window.backend.send(new FormData(a),L,x)})),i.addEventListener("click",(e=>{e.preventDefault(),window.main.deactivatePage(),s.src=t,g.innerHTML=""})),window.form={isPageActivated:!1,completeAddressInput:S,enableForm:()=>{window.form.isPageActivated=!0,E(a,!0),E(r,!0),S(),a.classList.remove("ad-form--disabled")},disableForm:()=>{window.form.isPageActivated=!1,E(a,!1),E(r,!1),S(),a.classList.add("ad-form--disabled"),q(),h()}}})(),(()=>{const e=document.querySelector(".map__pins"),t=e.querySelector(".map__pin--main"),o=document.querySelector("#pin").content.querySelector("button"),n=()=>({x:Math.round(parseInt(t.style.left,10)+31),y:window.form.isPageActivated?Math.round(parseInt(t.style.top,10)+62+22):Math.round(parseInt(t.style.top,10)+31)}),r=()=>{const e=n();parseInt(e.x,10)<0&&(t.style.left="-31px"),parseInt(e.x,10)>1199&&(t.style.left="1168px"),parseInt(e.y,10)<130&&(t.style.top="46px"),parseInt(e.y,10)>630&&(t.style.top="546px")},a=e=>{const t=o.cloneNode(!0);return t.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,t.dataset.id=""+e.id,t.querySelector("img").src=""+e.author.avatar,t.querySelector("img").alt=""+e.offer.title,t},i=()=>{e.querySelectorAll(".map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}))};t.addEventListener("mousedown",(e=>{if(0===e.button){e.preventDefault();const o={x:e.clientX,y:e.clientY},n=e=>{e.preventDefault();const n=e.clientX-o.x,a=e.clientY-o.y;o.x=e.clientX,o.y=e.clientY,t.style.left=t.offsetLeft+n+"px",t.style.top=t.offsetTop+a+"px",r(),window.form.completeAddressInput()},a=e=>{e.preventDefault(),window.form.completeAddressInput(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a),window.form.isPageActivated||window.main.activatePage()}})),t.addEventListener("keydown",(e=>{e.key!==window.util.Key.ENTER||window.form.isPageActivated||window.main.activatePage()})),window.pin={mainMapPinReset:()=>{t.style="left: 570px; top: 375px;"},getMainMapPinCoords:n,controlsMainMapPinCoords:r,deleteOfferPins:i,updateOfferPins:t=>{i(),window.card.closePopup(),(t=>{const o=document.createDocumentFragment();for(let e=0;e<t.length;e++)o.append(a(t[e]));e.append(o)})(t)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".popup");let o,n;const r=e=>{const{author:{avatar:o},id:n,offer:{title:r,address:a,price:i,type:d,rooms:s,guests:c,checkin:l,checkout:u,features:p,description:m,photos:f}}=e,w=t.cloneNode(!0),y=w.querySelector(".popup__avatar"),v=w.querySelector(".popup__title"),_=w.querySelector(".popup__text--address"),g=w.querySelector(".popup__text--price"),E=w.querySelector(".popup__type"),S=w.querySelector(".popup__text--capacity"),q=w.querySelector(".popup__text--time"),h=w.querySelector(".popup__features"),L=w.querySelector(".popup__description"),x=w.querySelector(".popup__photos");return n&&(w.dataset.id=n),y.src=o||y.remove(),v.textContent=r,_.textContent=a,g.innerHTML=i?i+"&#x20bd;<span>/ночь</span>":"",E.textContent=window.util.getHousingType(d),S.textContent=s&&c?`${window.util.getQEndings(s,"room")} для ${window.util.getQEndings(c,"guest")}`:"",q.textContent=l&&u?`Заезд после ${l}, выезд до ${u}`:"",((e,t)=>{e.innerHTML="";for(let o=0;o<t.length;o++){const n=document.createElement("li");n.classList.add("popup__feature","popup__feature--"+t[o]),e.append(n)}})(h,p),L.textContent=m,((e,t)=>{const o=e.querySelector(".popup__photo");e.innerHTML="",t.forEach((t=>{const n=o.cloneNode(!0);n.src=t,e.append(n)}))})(x,f),(e=>{Array.from(e.children).forEach((e=>{"IMG"===e.tagName||e.innerHTML||e.remove()}))})(w),w},a=()=>{o&&(e.removeChild(o),o=null)},i=()=>{e.querySelector(".map__pin--active").classList.remove("map__pin--active"),a()},d=t=>{t.key===window.util.Key.ESCAPE&&(t.preventDefault(),e.querySelector(".map__pin--active").classList.remove("map__pin--active"),a())},s=e=>{e.key===window.util.Key.ENTER&&(e.preventDefault(),a())};window.card={renderOfferCard:r,closePopup:a,openOffer:t=>{if(t.target.closest(".map__pin")){const c=t.target.closest(".map__pin"),l=e.querySelector(".map__pin--active"),u=c.dataset.id;l&&l.dataset.id===u||!u||(l&&l.classList.remove("map__pin--active"),c.classList.add("map__pin--active"),a(),(t=>{const a=window.card.offersWithId.find((e=>e.id===t));o=r(a),e.append(o),n=o.querySelector(".popup__close"),n.addEventListener("click",i),n.addEventListener("keydown",s),document.addEventListener("keydown",d)})(u))}}}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),i=t.querySelectorAll(".map__checkbox"),d=t=>{switch(n.value){case"middle":return t.offer.price>=1e4&&t.offer.price<=5e4;case"low":return t.offer.price<1e4;case"high":return t.offer.price>5e4;default:return n.value===e}},s=t=>r.value===e||t.offer.rooms===+r.value,c=t=>a.value===e||t.offer.guests===+a.value,l=e=>{for(const t of i)if(t.checked&&!e.offer.features.includes(t.value))return!1;return!0},u=t=>{const n=[];for(let a=0;a<t.length&&n.length<5;a++)r=t[a],(o.value===e||r.offer.type===o.value)&&d(t[a])&&s(t[a])&&c(t[a])&&l(t[a])&&n.push(t[a]);var r;return n};t.addEventListener("change",window.util.debounce((()=>{window.pin.updateOfferPins(u(window.card.offersWithId))}))),window.filter={filterOffers:u}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=document.querySelector(".map__filters"),n=document.querySelector(".ad-form"),r=e=>{window.card.offersWithId=window.util.addId(e),window.pin.updateOfferPins(window.filter.filterOffers(window.card.offersWithId))},a=e=>{const t=document.createElement("div");t.classList.add("on-error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},i=()=>{window.form.disableForm(),window.pin.deleteOfferPins(),e.classList.add("map--faded"),n.reset(),o.reset(),window.card.closePopup(),window.pin.mainMapPinReset(),window.form.completeAddressInput()};i(),t.addEventListener("click",(e=>{window.card.openOffer(e)})),t.addEventListener("keydown",(e=>{e.key===window.util.Key.ENTER&&window.card.openOffer(e)})),window.main={activatePage:()=>{window.form.enableForm(),e.classList.remove("map--faded"),window.backend.load(r,a)},deactivatePage:i}})()})();