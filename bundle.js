(()=>{"use strict";(()=>{const e={room:["комната","комнаты","комнат"],guest:["гостя","гостей","гостей"]},t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},o=(e=0,t=100)=>e+Math.floor(Math.random()*(t-e+1));window.util={getRandomIntNumber:o,getRandomArrayElements:(e,t=1)=>{let n=e.slice(),r=[];for(let e=0;e<n.length&&e<t;e++){const t=o(e,n.length-1);r.push(n[t]);const a=n[t];n[t]=n[e],n[e]=a}return r},getQEndings:(t=1,o)=>{if(t%100<11||t%100>14){if(t%10==1)return`${t} ${e[o][0]}`;if(t%10>1&&t%10<5)return`${t} ${e[o][1]}`}return`${t} ${e[o][2]}`},getHousingType:e=>t[e],addId:e=>{const t=e.slice();return t.forEach(((e,t)=>{e.id=""+t})),t},debounce:(e,t=500)=>{let o=null;return function(...n){o&&window.clearTimeout(o),o=window.setTimeout((()=>{e.apply(null,[...n])}),t)}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o,n,r)=>{const a=new XMLHttpRequest;a.responseType="json",a.timeout=1e4,a.open(e,t),"POST"===e?a.send(r):a.send(),a.addEventListener("load",(()=>{200===a.status?o(a.response):n(`Статус ответа: ${a.status} ${a.statusText}`)})),a.addEventListener("error",(function(){n("Произошла ошибка соединения")})),a.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${a.timeout/1e3} с`)}))};window.backend={load:(o,n)=>{t("GET",e+"/data",o,n)},send:(o,n,r)=>{t("POST",e,n,r,o)}}})(),(()=>{const e={palace:1e4,flat:1e3,house:5e3,bungalow:0},t={1:'<option value="1" selected>для 1 гостя</option>',2:'<option value="2">для 2 гостей</option>\n        <option value="1" selected>для 1 гостя</option>',3:'<option value="3">для 3 гостей</option>\n        <option value="2">для 2 гостей</option>\n        <option value="1" selected>для 1 гостя</option>',100:'<option value="0" selected>не для гостей</option>'},o=document.querySelector(".ad-form"),n=document.querySelector(".ad-form__reset"),r=o.querySelector("#title"),a=o.querySelector("#address"),i=o.querySelector("#price"),s=o.querySelector("#type"),d=o.querySelector(".ad-form__element--time"),c=o.querySelector("#timein"),l=o.querySelector("#timeout"),u=o.querySelector("#room_number"),p=o.querySelector("#capacity"),m=(e,t)=>{e.querySelectorAll("fieldset").forEach((e=>{e.disabled=!t}))},f=()=>{const e=window.pin.getMainMapPinCoords();a.value=`${e.x}, ${e.y}`},y=()=>{p.innerHTML=t[u.value]},v=()=>{const t=e[s.value];i.placeholder=t,i.min=t},w=()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);e.append(t),t.addEventListener("click",(()=>{t.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&t.remove()})),o.reset(),window.main.deactivatePage()},_=()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);e.append(t),t.addEventListener("click",(()=>{t.remove()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&t.remove()}))};r.addEventListener("input",(()=>{const e=r.value.length;e<30?r.setCustomValidity(`Еще ${30-e} символов`):e>100?r.setCustomValidity(`Удалите лишние ${e-100} символов`):r.setCustomValidity(""),r.reportValidity()})),i.addEventListener("input",(()=>{const t=i.value,o=e[s.value];t<o?i.setCustomValidity(`Минимальная цена за ночь ${o} руб. Вам стоит увеличить цену.`):t>1e6?i.setCustomValidity("Максимальная цена за ночь 1000000 руб. Вам стоит уменьшить цену."):i.setCustomValidity(""),i.reportValidity()})),s.addEventListener("change",(()=>{v()})),d.addEventListener("change",(e=>{l.value=e.target.value,c.value=e.target.value})),u.addEventListener("change",(()=>{y()})),o.addEventListener("submit",(e=>{e.preventDefault(),window.backend.send(new FormData(o),w,_)})),n.addEventListener("click",(e=>{e.preventDefault(),o.reset(),f(),v()})),window.form={isPageActivated:!1,completeAddressInput:f,enableForm:()=>{window.form.isPageActivated=!0,m(o,!0),f(),o.classList.remove("ad-form--disabled")},disableForm:()=>{window.form.isPageActivated=!1,m(o,!1),f(),o.classList.add("ad-form--disabled"),y(),v()}}})(),(()=>{const e=document.querySelector(".map__pins"),t=e.querySelector(".map__pin--main"),o=document.querySelector("#pin").content.querySelector("button"),n=()=>({x:Math.round(parseInt(t.style.left,10)+31),y:window.form.isPageActivated?Math.round(parseInt(t.style.top,10)+62+22):Math.round(parseInt(t.style.top,10)+31)}),r=()=>{const e=n();parseInt(e.x,10)<0&&(t.style.left="-31px"),parseInt(e.x,10)>1199&&(t.style.left="1168px"),parseInt(e.y,10)<130&&(t.style.top="46px"),parseInt(e.y,10)>630&&(t.style.top="546px")},a=e=>{const t=o.cloneNode(!0);return t.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,t.dataset.id=""+e.id,t.querySelector("img").src=""+e.author.avatar,t.querySelector("img").alt=""+e.offer.title,t},i=()=>{e.querySelectorAll(".map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}))};t.addEventListener("mousedown",(e=>{e.preventDefault();const o={x:e.clientX,y:e.clientY},n=e=>{e.preventDefault();const n=e.clientX-o.x,a=e.clientY-o.y;o.x=e.clientX,o.y=e.clientY,t.style.left=t.offsetLeft+n+"px",t.style.top=t.offsetTop+a+"px",r(),window.form.completeAddressInput()},a=e=>{e.preventDefault(),window.form.completeAddressInput(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a),window.form.isPageActivated||window.main.activatePage()})),t.addEventListener("keydown",(e=>{e.preventDefault(),"Enter"!==e.key||window.form.isPageActivated||window.main.activatePage()})),window.pin={mainMapPinReset:()=>{t.style="left: 570px; top: 375px;"},getMainMapPinCoords:n,controlsMainMapPinCoords:r,deleteOfferPins:i,updateOfferPins:t=>{i(),window.card.closePopup(),(t=>{const o=document.createDocumentFragment();for(let e=0;e<t.length;e++)o.append(a(t[e]));e.append(o)})(t)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector("#card").content.querySelector(".popup");let o,n;const r=e=>{const{author:{avatar:o},id:n,offer:{title:r,address:a,price:i,type:s,rooms:d,guests:c,checkin:l,checkout:u,features:p,description:m,photos:f}}=e,y=t.cloneNode(!0),v=y.querySelector(".popup__avatar"),w=y.querySelector(".popup__title"),_=y.querySelector(".popup__text--address"),g=y.querySelector(".popup__text--price"),S=y.querySelector(".popup__type"),q=y.querySelector(".popup__text--capacity"),h=y.querySelector(".popup__text--time"),E=y.querySelector(".popup__features"),L=y.querySelector(".popup__description"),x=y.querySelector(".popup__photos");return n&&(y.dataset.id=n),v.src=o||v.remove(),w.textContent=r,_.textContent=a,g.innerHTML=i?i+"&#x20bd;<span>/ночь</span>":"",S.textContent=window.util.getHousingType(s),q.textContent=d&&c?`${window.util.getQEndings(d,"room")} для ${window.util.getQEndings(c,"guest")}`:"",h.textContent=l&&u?`Заезд после ${l}, выезд до ${u}`:"",((e,t)=>{e.innerHTML="";for(let o=0;o<t.length;o++){const n=document.createElement("li");n.classList.add("popup__feature","popup__feature--"+t[o]),e.append(n)}})(E,p),L.textContent=m,((e,t)=>{const o=e.querySelector(".popup__photo");e.innerHTML="",t.forEach((t=>{const n=o.cloneNode(!0);n.src=t,e.append(n)}))})(x,f),(e=>{Array.from(e.children).forEach((e=>{"IMG"===e.tagName||e.innerHTML||e.remove()}))})(y),y},a=()=>{o&&(e.removeChild(o),o=null)},i=()=>{e.querySelector(".map__pin--active").classList.remove("map__pin--active"),a()},s=t=>{"Escape"===t.key&&(t.preventDefault(),e.querySelector(".map__pin--active").classList.remove("map__pin--active"),a())},d=e=>{"Enter"===e.key&&(e.preventDefault(),a())};window.card={renderOfferCard:r,closePopup:a,openOffer:t=>{if(t.target.closest(".map__pin")){const c=t.target.closest(".map__pin"),l=e.querySelector(".map__pin--active"),u=c.dataset.id;l&&l.dataset.id===u||!u||(l&&l.classList.remove("map__pin--active"),c.classList.add("map__pin--active"),a(),(t=>{const a=window.card.offersWithId.find((e=>e.id===t));o=r(a),e.append(o),n=o.querySelector(".popup__close"),n.addEventListener("click",i),n.addEventListener("keydown",d),document.addEventListener("keydown",s)})(u))}}}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),i=t.querySelectorAll(".map__checkbox"),s=t=>{switch(n.value){case"middle":return t.offer.price>=1e4&&t.offer.price<=5e4;case"low":return t.offer.price<1e4;case"high":return t.offer.price>5e4;default:return n.value===e}},d=t=>r.value===e||t.offer.rooms===+r.value,c=t=>a.value===e||t.offer.guests===+a.value,l=e=>{for(const t of i)if(t.checked&&!e.offer.features.includes(t.value))return!1;return!0},u=t=>{const n=[];for(let a=0;a<t.length&&n.length<5;a++)r=t[a],(o.value===e||r.offer.type===o.value)&&s(t[a])&&d(t[a])&&c(t[a])&&l(t[a])&&n.push(t[a]);var r;return n};t.addEventListener("change",window.util.debounce((()=>{window.pin.updateOfferPins(u(window.card.offersWithId))}))),window.filter={filterOffers:u}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=document.querySelector(".map__filters"),n=e=>{window.card.offersWithId=window.util.addId(e),window.pin.updateOfferPins(window.filter.filterOffers(window.card.offersWithId))},r=e=>{const t=document.createElement("div");t.classList.add("on-error-message"),t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},a=()=>{window.form.disableForm(),window.pin.deleteOfferPins(),e.classList.add("map--faded"),o.reset(),window.pin.mainMapPinReset()};a(),t.addEventListener("click",(e=>{window.card.openOffer(e)})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&window.card.openOffer(e)})),window.main={activatePage:()=>{window.form.enableForm(),e.classList.remove("map--faded"),window.backend.load(n,r)},deactivatePage:a}})()})();